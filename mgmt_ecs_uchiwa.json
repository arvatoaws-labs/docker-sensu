{
  "Description": "AWS CloudFormation Template for ECS Uchiwa",
  "Outputs": {
    "ContainerName": {
      "Description": "Container Name",
      "Value": {
        "Ref": "ContainerName"
      }
    },
    "ContainerServiceArn": {
      "Description": "Container Service ARN",
      "Value": {
        "Ref": "ContainerService"
      }
    },
    "ContainerTaskdefinitionArn": {
      "Description": "Container TaskDefinition",
      "Value": {
        "Ref": "ContainerTaskdefinition"
      }
    },
    "UchiwaDnsExtRecord": {
      "Description": "Uchiwa DNS external record",
      "Value": {
        "Ref": "UchiwaDnsExtRecord"
      }
    }
  },
  "Parameters": {
    "ContainerAdjustmentNumberHighDown": {
      "Default": "-50",
      "Description": "The amount by which to scale.",
      "Type": "String"
    },
    "ContainerAdjustmentNumberHighUp": {
      "Default": "100",
      "Description": "The amount by which to scale.",
      "Type": "String"
    },
    "ContainerAdjustmentNumberLowDown": {
      "Default": "-20",
      "Description": "The amount by which to scale.",
      "Type": "String"
    },
    "ContainerAdjustmentNumberLowUp": {
      "Default": "50",
      "Description": "The amount by which to scale.",
      "Type": "String"
    },
    "ContainerAlarmEvaluationPeriod": {
      "Default": "1",
      "Description": "The number of periods over which data is compared to the specified threshold.",
      "Type": "String"
    },
    "ContainerAlarmPeriod": {
      "Default": "60",
      "Description": "The time over which the specified statistic is applied.",
      "Type": "String"
    },
    "ContainerAlarmTresholdDown": {
      "Default": "50",
      "Description": "The value against which the specified statistic is compared.",
      "Type": "String"
    },
    "ContainerAlarmTresholdUp": {
      "Default": "75",
      "Description": "The value against which the specified statistic is compared.",
      "Type": "String"
    },
    "ContainerAutoscalingRole": {
      "Description": "Container autoscaling role (ARN)",
      "Type": "String"
    },
    "ContainerCooldown": {
      "Default": "300",
      "Description": "The amount of time, in seconds, after a scaling activity completes before any further trigger-related scaling activities can start.",
      "Type": "String"
    },
    "ContainerCpu": {
      "Default": "256",
      "Description": "ECS Service CPU usage",
      "Type": "String"
    },
    "ContainerDesiredCount": {
      "Default": "2",
      "Description": "The scalable dimension thatÂ´s associated with the scalable target.",
      "Type": "String"
    },
    "ContainerHost": {
      "Default": "default",
      "Description": "Container Host",
      "Type": "String"
    },
    "ContainerMaxCapacity": {
      "Default": "4",
      "Description": "The maximum value that Application Auto Scaling can use to scale a target during a scaling activity.",
      "Type": "String"
    },
    "ContainerMemory": {
      "Default": "256",
      "Description": "ECS Service Memory usage",
      "Type": "String"
    },
    "ContainerMemoryReservation": {
      "Default": "256",
      "Description": "ECS Service Memory reservation usage",
      "Type": "String"
    },
    "ContainerMetricIntervalLowerBoundDown": {
      "Default": "-10",
      "Description": "The lower bound of the breach size",
      "Type": "String"
    },
    "ContainerMetricIntervalLowerBoundUp": {
      "Default": "0",
      "Description": "The lower bound of the breach size",
      "Type": "String"
    },
    "ContainerMetricIntervalUpperBoundDown": {
      "Default": "0",
      "Description": "The upper bound of the breach size",
      "Type": "String"
    },
    "ContainerMetricIntervalUpperBoundUp": {
      "Default": "10",
      "Description": "The upper bound of the breach size",
      "Type": "String"
    },
    "ContainerMinCapacity": {
      "Default": "1",
      "Description": "The minimum value that Application Auto Scaling can use to scale a target during a scaling activity.",
      "Type": "String"
    },
    "ContainerName": {
      "Description": "Name of the ECS Container Service",
      "Type": "String"
    },
    "ContainerPort": {
      "Description": "ECS Container Port",
      "Type": "String"
    },
    "ContainerRepository": {
      "Default": "none",
      "Description": "ECS public repository",
      "Type": "String"
    },
    "ContainerTag": {
      "Default": "latest",
      "Description": "Tag of the docker image to use",
      "Type": "String"
    },
    "EcsFrontendElbPublicIp": {
      "Description": "Elasticloadbalancer public DNS",
      "Type": "String"
    },
    "ElbFrontOrBack": {
      "Description": "Elastic loadbalancer (Frontend or Backend)",
      "Type": "String"
    },
    "ElbHealthCheckIntervalSeconds": {
      "Default": "30",
      "Description": "Elastic loadbalancer Health Check interval in seconds",
      "Type": "String"
    },
    "ElbHealthCheckTimeoutSeconds": {
      "Default": "15",
      "Description": "Elastic loadbalancer Health Checks timeout in seconds",
      "Type": "String"
    },
    "ElbHealthyThresholdCount": {
      "Default": "2",
      "Description": "Elastic loadbalancer healthy threshold count",
      "Type": "String"
    },
    "ElbPortListener": {
      "Default": "none",
      "Description": "ELB port listener, (If different from Container)",
      "Type": "String"
    },
    "ElbUnhealthyThresholdCount": {
      "Default": "5",
      "Description": "Elastic loadbalancer unhealthy threshold count",
      "Type": "String"
    },
    "ExternalZoneId": {
      "Type": "String"
    },
    "ExternalZoneName": {
      "Type": "String"
    },
    "HostEfsPath": {
      "Default": "/share/uchiwa",
      "Description": "The path on the host that you want to mount",
      "Type": "String"
    },
    "LoadbalancerServiceRoleArn": {
      "Description": "Elasticloadbalancer service role (ARN)",
      "Type": "String"
    },
    "VpcId": {
      "Description": "VPC ID",
      "Type": "AWS::EC2::VPC::Id"
    }
  },
  "Resources": {
    "ContainerAlarmScaleDown": {
      "Properties": {
        "AlarmActions": [
          {
            "Ref": "ContainerScalingPolicyDown"
          }
        ],
        "AlarmDescription": {
          "Fn::Join": [
            "",
            [
              "CPU Utilization low on ",
              {
                "Ref": "ContainerName"
              },
              " container"
            ]
          ]
        },
        "ComparisonOperator": "LessThanThreshold",
        "Dimensions": [
          {
            "Name": "ServiceName",
            "Value": {
              "Ref": "ContainerName"
            }
          },
          {
            "Name": "ClusterName",
            "Value": {
              "Ref": "ContainerHost"
            }
          }
        ],
        "EvaluationPeriods": {
          "Ref": "ContainerAlarmEvaluationPeriod"
        },
        "MetricName": "CPUUtilization",
        "Namespace": "AWS/ECS",
        "Period": {
          "Ref": "ContainerAlarmPeriod"
        },
        "Statistic": "Average",
        "Threshold": {
          "Ref": "ContainerAlarmTresholdDown"
        }
      },
      "Type": "AWS::CloudWatch::Alarm"
    },
    "ContainerAlarmScaleUp": {
      "Properties": {
        "AlarmActions": [
          {
            "Ref": "ContainerScalingPolicyUp"
          }
        ],
        "AlarmDescription": {
          "Fn::Join": [
            "",
            [
              "CPU Utilization high on ",
              {
                "Ref": "ContainerName"
              },
              " container"
            ]
          ]
        },
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "ServiceName",
            "Value": {
              "Ref": "ContainerName"
            }
          },
          {
            "Name": "ClusterName",
            "Value": {
              "Ref": "ContainerHost"
            }
          }
        ],
        "EvaluationPeriods": {
          "Ref": "ContainerAlarmEvaluationPeriod"
        },
        "MetricName": "CPUUtilization",
        "Namespace": "AWS/ECS",
        "Period": {
          "Ref": "ContainerAlarmPeriod"
        },
        "Statistic": "Average",
        "Threshold": {
          "Ref": "ContainerAlarmTresholdUp"
        }
      },
      "Type": "AWS::CloudWatch::Alarm"
    },
    "ContainerAutoScalingTarget": {
      "DependsOn": [
        "ContainerService"
      ],
      "Properties": {
        "MaxCapacity": {
          "Ref": "ContainerMaxCapacity"
        },
        "MinCapacity": {
          "Ref": "ContainerMinCapacity"
        },
        "ResourceId": {
          "Fn::Join": [
            "",
            [
              "service/",
              {
                "Ref": "ContainerHost"
              },
              "/",
              {
                "Ref": "ContainerName"
              }
            ]
          ]
        },
        "RoleARN": {
          "Ref": "ContainerAutoscalingRole"
        },
        "ScalableDimension": "ecs:service:DesiredCount",
        "ServiceNamespace": "ecs"
      },
      "Type": "AWS::ApplicationAutoScaling::ScalableTarget"
    },
    "ContainerScalingPolicyDown": {
      "Properties": {
        "PolicyName": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "ContainerName"
              },
              "-service-autoscaling-down"
            ]
          ]
        },
        "PolicyType": "StepScaling",
        "ScalableDimension": "ecs:service:DesiredCount",
        "ScalingTargetId": {
          "Ref": "ContainerAutoScalingTarget"
        },
        "ServiceNamespace": "ecs",
        "StepScalingPolicyConfiguration": {
          "AdjustmentType": "PercentChangeInCapacity",
          "Cooldown": {
            "Ref": "ContainerCooldown"
          },
          "MetricAggregationType": "Average",
          "StepAdjustments": [
            {
              "MetricIntervalUpperBound": {
                "Ref": "ContainerMetricIntervalUpperBoundDown"
              },
              "MetricIntervalLowerBound": {
                "Ref": "ContainerMetricIntervalLowerBoundDown"
              },
              "ScalingAdjustment": {
                "Ref": "ContainerAdjustmentNumberLowDown"
              }
            },
            {
              "MetricIntervalUpperBound": {
                "Ref": "ContainerMetricIntervalLowerBoundDown"
              },
              "ScalingAdjustment": {
                "Ref": "ContainerAdjustmentNumberHighDown"
              }
            }
          ]
        }
      },
      "Type": "AWS::ApplicationAutoScaling::ScalingPolicy"
    },
    "ContainerScalingPolicyUp": {
      "Properties": {
        "PolicyName": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "ContainerName"
              },
              "-service-autoscaling-up"
            ]
          ]
        },
        "PolicyType": "StepScaling",
        "ScalableDimension": "ecs:service:DesiredCount",
        "ScalingTargetId": {
          "Ref": "ContainerAutoScalingTarget"
        },
        "ServiceNamespace": "ecs",
        "StepScalingPolicyConfiguration": {
          "AdjustmentType": "PercentChangeInCapacity",
          "Cooldown": {
            "Ref": "ContainerCooldown"
          },
          "MetricAggregationType": "Average",
          "StepAdjustments": [
            {
              "MetricIntervalUpperBound": {
                "Ref": "ContainerMetricIntervalUpperBoundUp"
              },
              "MetricIntervalLowerBound": {
                "Ref": "ContainerMetricIntervalLowerBoundUp"
              },
              "ScalingAdjustment": {
                "Ref": "ContainerAdjustmentNumberLowUp"
              }
            },
            {
              "MetricIntervalLowerBound": {
                "Ref": "ContainerMetricIntervalUpperBoundUp"
              },
              "ScalingAdjustment": {
                "Ref": "ContainerAdjustmentNumberHighUp"
              }
            }
          ]
        }
      },
      "Type": "AWS::ApplicationAutoScaling::ScalingPolicy"
    },
    "ContainerService": {
      "DependsOn": [
        "ContainerTargetGroupHttp",
        "ElbListener"
      ],
      "Properties": {
        "Cluster": {
          "Ref": "ContainerHost"
        },
        "DesiredCount": {
          "Ref": "ContainerDesiredCount"
        },
        "LoadBalancers": [
          {
            "TargetGroupArn": {
              "Ref": "ContainerTargetGroupHttp"
            },
            "ContainerName": {
              "Ref": "ContainerName"
            },
            "ContainerPort": {
              "Ref": "ContainerPort"
            }
          }
        ],
        "PlacementStrategies": [
          {
            "Field": "attribute:ecs.availability-zone",
            "Type": "spread"
          },
          {
            "Field": "instanceId",
            "Type": "spread"
          }
        ],
        "Role": {
          "Ref": "LoadbalancerServiceRoleArn"
        },
        "ServiceName": {
          "Ref": "ContainerName"
        },
        "TaskDefinition": {
          "Ref": "ContainerTaskdefinition"
        }
      },
      "Type": "AWS::ECS::Service"
    },
    "ContainerTargetGroupHttp": {
      "Properties": {
        "HealthCheckIntervalSeconds": {
          "Ref": "ElbHealthCheckIntervalSeconds"
        },
        "HealthCheckPath": "/health",
        "HealthCheckProtocol": "HTTP",
        "HealthCheckTimeoutSeconds": {
          "Ref": "ElbHealthCheckTimeoutSeconds"
        },
        "HealthyThresholdCount": {
          "Ref": "ElbHealthyThresholdCount"
        },
        "Matcher": {
          "HttpCode": "200"
        },
        "Name": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "ContainerName"
              },
              "-",
              {
                "Ref": "ContainerPort"
              }
            ]
          ]
        },
        "Port": {
          "Ref": "ContainerPort"
        },
        "Protocol": "HTTP",
        "UnhealthyThresholdCount": {
          "Ref": "ElbUnhealthyThresholdCount"
        },
        "VpcId": {
          "Ref": "VpcId"
        }
      },
      "Type": "AWS::ElasticLoadBalancingV2::TargetGroup"
    },
    "ContainerTaskdefinition": {
      "Properties": {
        "ContainerDefinitions": [
          {
            "Name": {
              "Ref": "ContainerName"
            },
            "Image": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "ContainerRepository"
                  },
                  "uchiwa:",
                  {
                    "Ref": "ContainerTag"
                  }
                ]
              ]
            },
            "Cpu": {
              "Ref": "ContainerCpu"
            },
            "Memory": {
              "Ref": "ContainerMemory"
            },
            "MemoryReservation": {
              "Ref": "ContainerMemoryReservation"
            },
            "LogConfiguration": {
              "LogDriver": "awslogs",
              "Options": {
                "awslogs-region": {
                  "Ref": "AWS::Region"
                },
                "awslogs-group": "ECS-Docker",
                "awslogs-stream-prefix": {
                  "Ref": "ContainerHost"
                }
              }
            },
            "PortMappings": [
              {
                "ContainerPort": {
                  "Ref": "ContainerPort"
                }
              }
            ],
            "MountPoints": [
              {
                "ReadOnly": "false",
                "ContainerPath": "/config",
                "SourceVolume": "files"
              }
            ]
          }
        ],
        "Family": {
          "Ref": "ContainerName"
        },
        "Volumes": [
          {
            "Name": "files",
            "Host": {
              "SourcePath": {
                "Ref": "HostEfsPath"
              }
            }
          }
        ]
      },
      "Type": "AWS::ECS::TaskDefinition"
    },
    "ElbListener": {
      "DependsOn": [
        "ContainerTargetGroupHttp"
      ],
      "Properties": {
        "DefaultActions": [
          {
            "Type": "forward",
            "TargetGroupArn": {
              "Ref": "ContainerTargetGroupHttp"
            }
          }
        ],
        "LoadBalancerArn": {
          "Ref": "ElbFrontOrBack"
        },
        "Port": {
          "Ref": "ElbPortListener"
        },
        "Protocol": "HTTP"
      },
      "Type": "AWS::ElasticLoadBalancingV2::Listener"
    },
    "UchiwaDnsExtRecord": {
      "Properties": {
        "AliasTarget": {
          "DNSName": {
            "Ref": "EcsFrontendElbPublicIp"
          },
          "EvaluateTargetHealth": false,
          "HostedZoneId": "Z215JYRZR1TBD5"
        },
        "HostedZoneId": {
          "Ref": "ExternalZoneId"
        },
        "Name": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "ContainerName"
              },
              ".",
              {
                "Ref": "ExternalZoneName"
              }
            ]
          ]
        },
        "Type": "A"
      },
      "Type": "AWS::Route53::RecordSet"
    }
  }
}